---
title: "Database COVID/CASEN"
author: "Venegas, M & Lafferte, A"
date: "30 de mayo de 2020"
output: html_document
---

# Ayudantía Estadística Multivariada: Creación de base de datos para insumo

## Resumen ejecutivo

La base de datos "CASEN-COVID19.xlsx" consiste en una muestra de 324 comunas correspondiente a datos del 2017 y el 2019. Esta ha sido diseñada a partir de la unión de la base ["Casen 2017.sav"](http://observatorio.ministeriodesarrollosocial.gob.cl/casen-multidimensional/casen/basedatos.php) y ["CasosConfirmadosComuna.csv"](https://github.com/MinCiencia/Datos-COVID19/blob/master/output/producto2/2020-05-25-CasosConfirmados.csv), donde la base "CASEN 2017"" brinda los datos necesarios para una caracterización socioeconomica de la población chilena, y la base de datos de "CasosConfirmadosComuna"" consiste en una presentación en detalle de los casos confirmados con COVID- 19 por comuna al 27 de mayo del año 2020. Ambas fueron unidas a partir del procedimiento *merge* que permite unir dos bases de datos a partir de una *variable llave*, la cual en este caso fue la *comuna*. Trabajando con los datos sobre el COVID 19 y los datos agregados de la CASEN 2017 es que se logra construir esta base de datos.

Las variables que contiene esta base son las siguientes (en cursiva el nombre utilizado en la base de datos):

- Codigos de comuna = *comuna*
- Nombres de región = *nombres_region*
- Codigos de región = *region*
- Nombres de comuna = *nombres_comuna*
- Población de la comuna = *poblacion*
- Casos confirmados en la comuna = *casos_confirmados*
- Media de ingresos individuales a nivel comunal = *ingreso_media*
- Mediana de ingresos individuales a nivel comunal = *ingreso_mediana*
- Mediana de ingresos individuales a nivel comunal = *ingreso_desviacionestandar*
- Media de ingresos por hogares a nivel comunal = *ingresohogar_media*
- Mediana de ingresos por hogares a nivel comunal = *ingresohogar_mediana*
- Desviacion estandar de ingresos por hogares a nivel comunal = *ingresohogar_desviacionestandar*
- Media de edad a nivel comunal = *edad_media*
- Mediana de edad a nivel comunal = *edad_mediana*
- Desviacion estandar de edad a nivel comunal = *edad_desviacionestandar*
- Media de años de escolaridad a nivel comunal = *anosescolaridad_media*
- Mediana de años de escolaridad a nivel comunal = *anosescolaridad_mediana*
- Desviacion estandar de años de escolaridad a nivel comunal *anosescolaridad_desviacionestandar*
- Media de pobreza = *pobreza_media*
- Mediana de pobreza = *pobreza_mediana*
- Desviacion estandar pobreza = *pobreza_desviacionestandar*
- Media de hacinamiento en el hogar = *hacinamiento_hogar_media*
- Mediana de hacinamiento en el hogar = *hacinamiento_hogar_mediana*
- Desviacion estandar de hacinamiento en el hogar = *hacinamiento_hogar_desviacionestandar*
- Media de total personas en el hogar = *total_personas_hogar_media*
- Mediana de total de personas en el hogar = *total_personas_hogar_mediana*
- Desviacion estandar de total de personas en el hogar *total_personas_hogar_desviacionestandar*
- Media de deficit de adscripcion a sistema de salud = *deficit_prevs_hogar_media*
- Mediana de deficit de adscripcion a sistema de salud = *deficit_prevs_hogar_mediana*
- Desviacion estandar de deficit de adscripcion a sistema de salud = *deficit_prevs_hogar_desviacionestandar*
- Media de deficit de servicios basicos en el hogar = *deficit_servbas_hogar_media*
- Mediana de deicit de servicios basicos en el hogar = *deficit_servbas_hogar_mediana*
- Desviacion estandar de deficit de servicios basicos en el hogar = = *deficit_servbas_hogar_desviacionestandar*
- Porcentaje de sin educación formal a nivel comunal = *sineducformal_porcentaje*
- Porcentaje de basica incompleta a nivel comunal = *educbasicincomplete_porcentaje*
- Porcentaje de basica completa a nivel comunal = *educbasiccomplete_porcentaje*
- Porcentaje de media humanista incompleta a nivel comunal = *educhumincompleta_porcentaje*
- Porcentaje de media humanista completa a nivel comunal = *educhumcompleta_porcentaje*
- Porcentaje de media tecnica incompleta a nivel comunal = *eductecincompleta_porcentaje*
- Porcentaje de media tecnica completa a nivel comunal = *educteccompleta_porcentaje*
- Porcentaje de tecnico profesional incompleto a nivel comunal = *educsuptecincomplete_porcentaje*
- Porcentaje de tecnico profesional completo a nivel comunal = *educsupteccomplete_porcentaje*
- Porcentaje de profesional universitario incompleto a nivel comunal = *educsupprofincomplete_porcentaje*
- Porcentaje de profesional universitario completo a nivel comunal = *educsupprofcomplete_porcentaje*
- Porcentaje de postgrado incompleto a nivel comunal = *educsupostincomplete_porcentaje*
- Porcentaje de postgrado completo a nivel comunal = *educsuppostcomplete_porcentaje*
- Total de porcentajes de niveles educacionales por comuna = *total_niveleducacional*
- Porcentaje de hombres a nivel comunal = *hombre_porcentaje*
- Porcentaje de mujeres a nivel comunal = *mujer_porcentaje*
- Total de porcentajes de cada sexo por comuna = *total_sex*
- Porcentaje de sistema salud Fonasa A a nivel comunal = *fonasaA_porcentaje*
- Porcentaje de sistema salud Fonasa B a nivel comunal = *fonasaB_porcentaje*
- Porcentaje de sistema salud Fonasa C a nivel comunal = *fonasaC_porcentaje*
- Porcentaje de sistema salud Fonasa D a nivel comunal = *fonasaC_porcentaje*
- Porcentaje de sistema salud no conoce su grupo de Fonasa a nivel comunal = *fonasaNS_porcentaje*
- Porcentaje de sistema salud ffaa a nivel comunal = *ffaa_porcentaje*
- Porcentaje de sistema salud Isapre a nivel comunal = *isapre_porcentaje*
- Porcentaje sin previsión sistema salud (particulares) a nivel comunal = *ninguno_particular_porcentaje*
- Porcentaje de otro sistema salud a nivel comunal = *otrosistema_porcentaje*
- Porcentaje que no conoce su previsión de salud a nivel comunal = *nosabegrupo_porcentaje*
- Total de porcenajes de sistemas de salud por comuna = *total_sistsalud*
- Porcentaje de decil 1 a nivel comunal = *decil1_porcentaje*
- Porcentaje de decil 2 a nivel comunal = *decil2_porcentaje*
- Porcentaje de decil 3 a nivel comunal = *decil3_porcentaje*
- Porcentaje de decil 4 a nivel comunal = *decil4_porcentaje*
- Porcentaje de decil 5 a nivel comunal = *decil5_porcentaje*
- Porcentaje de decil 6 a nivel comunal = *decil6_porcentaje*
- Porcentaje de decil 7 a nivel comunal = *decil7_porcentaje*
- Porcentaje de decil 8 a nivel comunal = *decil8_porcentaje*
- Porcentaje de decil 9 a nivel comunal = *decil9_porcentaje*
- Porcentaje de decil 10 a nivel comunal = *decil10_porcentaje*
- Total de porcentajes de deciles por comuna = *total_deciles*
- Porcentaje de personas que habitan una vivienda menor a 30m por comuna = *tamano_vivienda_30m_porcentaje*
- Porcentaje de personas que habitan una vivienda entre 30m y 40m por comuna = *tamano_vivienda_30a40m_porcentaje*
- Porcentaje de personas que habitan una vivienda entre 41m y 60m por comuna = *tamano_vivienda_41a60m_porcentaje*
- Porcentaje de personas que habitan una vivienda entre 61m y 100m por comuna = *tamano_vivienda_61a100m_porcentaje*
- Porcentaje de personas que habitan una vivienda entre 101m y 150m por comuna = *tamano_vivienda_101a150m_porcentaje*
- Porcentaje de personas que habitan una vivienda de mas de 150m por comuna = *tamano_vivienda_150ymasm_porcentaje*
- Total de porcentajes de tamaño de vivienda por comuna = *total_tamano_vivienda*

## Introducción
Este documento tiene por objetivo construir una base de datos con la cual los y las estudiantes podrán explorar los datos respectivos al virus COVID - 19 y sus relaciones a nivel descriptivo con datos agregados a nivel comunal.Bajo esta propuesta es que se utilizarán como fuente la Encuesta de Caracterización Socioeconomica (CASEN) 2017 y la base de datos de contagiados con COVID 19 en el último informe epidemiológico brindado por el gobierno (25 de abril 2020). El producto final del presente documento es una base de datos puesta a dispocisión para los/as estudiantes en el desarrollo de la guía práctica N°3.

El contenido de este documento girará en torno a la exploración de los datos, el manejo y "limpieza"" de las bases de datos originales, con el objetivo de construir una base acorde a los objetivos del curso. Los principales procesos que se llevarán a cabe serán los siguientes:

1) Se cargarán las bases de datos pertinentes para el ejercicio, a saber; base de datos de distribución de infectados con COVID 19 a nivel comunal y la CASEN 2017.
2) Se seleccionarán las variables acordes al ejercicio (por ejemplo, nivel eduacional, ingresos, edad, sexo etc.) y se renombrarán en caso de ser necesario.
3) Se explorarán los datos en busca de casos atipicos o "anomalias".
4) En la base de datos de la CASEN 2017 se agruparán los datos a nivel comunal.
5) Se procederá a hacer un join con la base de datos del COVID 19 utilizando como llave la variable comuna.
6) Se extraerá la base de datos terminada en formato .xlsx


## Manejo de datos: exploración y limpieza

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = "hide")
options(scipen = 999)

```

En primer lugar, cargaremos los paquetes necesarios para el ejercicio
```{r include=FALSE}
# Cargar paquetes a utilizar
pacman::p_load(
               dplyr,
               sjlabelled,
               readxl,
               knitr,
               cran,
               openxlsx,
               DescTools,
               psych,
               descr,
               expss,
               car,
               writexl, 
               stargazer,
               kableExtra,
               sjmisc,
               )


```

Acto seguido, procedemos a cargar las bases de datos a utilizar
```{r}
#Base de datos COVID 19 al 25 de abril de 2020
BCV19c <- read.csv("2020-05-25-CasosConfirmados.csv")

#Base de datos CASEN 2017
BCASEN <- read_spss("Casen 2017.sav")
```

En la base de datos de la CASEN 2017 se seleccionan las variables a utilizar:
```{r}

#Selcción variables en CASEN 
BCASEN1 <- BCASEN %>% select (comuna, 
                                  edad, 
                                  sexo, 
                                  y1, 
                                  s12, 
                                  educ, 
                                  yoprcorh, 
                                  dau,
                                  ytotcorh,
                                  esc, 
                              pobreza,
                              hh_d_prevs,
                              hh_d_hacina,
                              hh_d_servbas,
                              tot_per,
                              v12)
```

Una vez seleccionadas las variables exploraremos los datos en busca de anomalías o cosas a considerar:
```{r}
#CASEN
# Descriptios de las variables escogidas
summary(BCASEN1)
freq(BCASEN1$edad)
count(BCASEN1[BCASEN1$edad >99,])

# El summary acá realizado muestra los siguientes datos a considerar:

# Para la edad figura un máximo de 117 años. Esto lleva a indagar la cantidad de casos que presentan arriba de 99 años, en tanto se considera una edad que sobrepasa en demasía la media de expectativa de vida chilena. Existen 39 casos con edades mayor a 99 años. Debido al poco n, no se les atribuye la categoría de NA.
#*NOTA* Los valores "0" significan residentes menores de 1 año.

freq(BCASEN1$educ)

# Para la educación, hay 1132 casos NS/NR, los cuales corresponden al 0.52% de la muestra. Se traspasan a NA, bajo la justificación de que la categoría NS/NR no será de suma relevancia para la tarea propuesta en este documento.

BCASEN1$educ[BCASEN1$educ== 99] <- NA

freq(BCASEN1$s12)

# Para el sistema de salud al cual se está adscrito existen 5197 casos bajo la categoría "No sabe", correspondiente al 2.4% de la muestra. En tanto puede ser una categoría relevante para el análisis poterior no se le atribuye la categoría de NA.

freq(BCASEN1$y1)

# Para los ingresos, hay 4354 casos que reportan no saber sus ingresos, los cuales corresponden al 6.3% valido (sin contar NA) de la muestra. Se asignarán como NA considerando que no aportan mayor información a los análisis posteriores.
#*NOTA* Los valores "0" significa que no han percibido ingresos.

BCASEN1$y1[BCASEN1$y1== 99] <- NA

#Metros cuadrados por vivienda. Aquí, el numero 9 representa el No sabe/No responde.
freq(BCASEN1$v12)
BCASEN1$v12[BCASEN1$v12== 9] <- NA

BCASEN1 <-sjlabelled::copy_labels(BCASEN1,BCASEN)


#COVID- 19 COMUNA (DATOS MINSAL AL 25 De ABRIL DE 2020)
sjmisc::descr(BCV19c,
      show = c("label","range", "mean", "sd", "NA.prc", "n"))%>%
      kable(.,"markdown")


```

Se procede a etiquetar las variables seleccionadas para la CASEN 2017
```{r}
#Etiquetación de variables CASEN.
BCASEN1 <- BCASEN1 %>% rename("comuna"=comuna, 
                                        "edad"=edad, 
                                        "ingreso"=y1, 
                                        "sexo"=sexo, 
                                        "educ"=educ, 
                                        "decilautonomo"=dau, 
                                        "sistemasalud"=s12, 
                                        "ingresocorregidoprincipal"=yoprcorh,
                                        "ingresohogar" =ytotcorh,
                              "pobreza"=pobreza,
                              "hacinamiento_hogar"=hh_d_hacina,
                              "total_personas_hogar"= tot_per,
                              "deficit_prevs_hogar"= hh_d_prevs,
                              "deficit_servbas_hogar"= hh_d_servbas,
                              "tamano_vivienda" = v12)

#Etiquetación de variables en base COVID19
BCV19c <- BCV19c %>% rename("comuna" = Codigo.comuna, "nombre_comuna" = Comuna, "nombre_region" = Region, "region" = Codigo.region, "poblacion" = Poblacion, "casos_confirmados" = Casos.Confirmados)
```




Se procede a hacer un agrupamiento de las variables de la casen a partir de la comuna:
```{r}
# Variables numericas

#Ingreso individual por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingreso_media = mean(ingreso, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingreso_mediana = median(ingreso, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingreso_desviacionestandar = sd(ingreso, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_ingind <- merge (BDC_memed, BDC_sd, by = "comuna")

#Ingreso hogar por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingresohogar_media = mean(ingresohogar, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingresohogar_mediana = median(ingresohogar, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(ingresohogar_desviacionestandar = sd(ingresohogar, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_inghog <- merge (BDC_memed, BDC_sd, by = "comuna")


#Edad por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(edad_media = mean(edad, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(edad_mediana = median(edad, na.rm = TRUE))

# Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(edad_desviacionestandar = sd(edad, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_edad <- merge (BDC_memed, BDC_sd, by = "comuna")

# Años escolaridad por comuna
#Media.
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(anosescolaridad_media = mean(esc, na.rm = TRUE))

#Mediana.
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(anosescolaridad_mediana = median(esc, na.rm = TRUE))

# Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(anosescolaridad_desviacionestandar = sd(esc, na.rm = TRUE))

#Merge
BDC_memed <- merge (BDC_me, BDC_med, by = "comuna")
BDC_edan <- merge (BDC_memed, BDC_sd, by = "comuna")

#Pobreza hogar por comuna (pobreza por ingresos por hogar)
#Media
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(pobreza_media = mean(pobreza, na.rm = TRUE))

#Mediana
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(pobreza_mediana = median(pobreza, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(pobreza_desviacionestandar = sd(pobreza, na.rm = TRUE))

#Merge 
BDC_memed <- merge(BDC_me, BDC_med, by = "comuna")
BDC_pobreza <- merge (BDC_memed, BDC_sd, by = "comuna")

#Hacinamiento del hogar por comuna 
#Media 
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(hacinamiento_hogar_media = mean(hacinamiento_hogar, na.rm = TRUE))

#Mediana
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(hacinamiento_hogar_mediana = median(hacinamiento_hogar, na.rm = TRUE))

#Desviación estandar 
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(hacinamiento_hogar_desviacionestandar = sd(pobreza, na.rm = TRUE))

#Merge
BDC_memed <- merge(BDC_me, BDC_med, by = "comuna")
BDC_hacinamiento_hogar <- merge(BDC_memed, BDC_sd, by ="comuna")


#Total de personas por hogar por comuna
#Media
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(total_personas_hogar_media = mean(total_personas_hogar, na.rm = TRUE))

#Mediana
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(total_personas_hogar_mediana = median(total_personas_hogar, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(total_personas_hogar_desviacionestandar = sd(total_personas_hogar, na.rm = TRUE))

#Merge 
BDC_memed <- merge(BDC_me, BDC_med, by = "comuna")
BDC_total_personas_hogar <- merge (BDC_memed, BDC_sd, by = "comuna")


#Hogar carente en adscripción al sistema de salud por comuna
#Media
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(deficit_prevs_hogar_media = mean(deficit_prevs_hogar, na.rm = TRUE))

#Mediana
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(deficit_prevs_hogar_mediana = median(deficit_prevs_hogar, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(deficit_prevs_hogar_desviacionestandar = sd(deficit_prevs_hogar, na.rm = TRUE))

#Merge 
BDC_memed <- merge(BDC_me, BDC_med, by = "comuna")
BDC_deficit_prevs_hogar <- merge (BDC_memed, BDC_sd, by = "comuna")

#Hogar carente de servicios básicos por comuna 
#Media
BDC_me <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(deficit_servbas_hogar_media = mean(deficit_servbas_hogar, na.rm = TRUE))

#Mediana
BDC_med <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(deficit_servbas_hogar_mediana = median(deficit_servbas_hogar, na.rm = TRUE))

#Desviación estandar
BDC_sd <- BCASEN1 %>% 
  group_by(comuna) %>% 
  summarise(deficit_servbas_hogar_desviacionestandar = sd(deficit_servbas_hogar, na.rm = TRUE))

#Merge 
BDC_memed <- merge(BDC_me, BDC_med, by = "comuna")
BDC_deficit_servbas_hogar <- merge (BDC_memed, BDC_sd, by = "comuna")

#Tamaño vivienda en mt por comuna 
#Media
#BDC_me <- BCASEN1 %>% 
 # group_by(comuna) %>% 
  #summarise(tamano_viv_media = mean(tamano_vivienda, na.rm = TRUE))

#Mediana
#BDC_med <- BCASEN1 %>% 
 # group_by(comuna) %>% 
  #summarise(tamano_viv_mediana = median(tamano_vivienda, na.rm = TRUE))

#Desviación estandar
#BDC_sd <- BCASEN1 %>% 
 # group_by(comuna) %>% 
  #summarise(tamano_viv_desviacionestandar = sd(tamano_vivienda, na.rm = TRUE))

#Merge 
#BDC_memed <- merge(BDC_me, BDC_med, by = "comuna")
#BDC_tamviv <- merge (BDC_memed, BDC_sd, by = "comuna")




#Merges de las variables
BDC_ing <- merge(BDC_ingind, BDC_inghog, by = "comuna")
BDC_ingyedad <- merge(BDC_ing, BDC_edad, by = "comuna")
BDC_num <- merge(BDC_ingyedad, BDC_edan, by = "comuna")
#Merge con variables nuevas 
BDC_num <- merge(BDC_num, BDC_pobreza, by = "comuna")
BDC_num <- merge(BDC_num, BDC_hacinamiento_hogar, by = "comuna")
BDC_num <- merge(BDC_num, BDC_total_personas_hogar, by = "comuna")
BDC_num <- merge(BDC_num, BDC_deficit_prevs_hogar, by = "comuna")
BDC_num <- merge(BDC_num, BDC_deficit_servbas_hogar, by = "comuna")
#BDC_num <- merge(BDC_num, BDC_tamviv, by = "comuna")
```

```{r}
# Variables categoricas

# Sexo
# Porcentaje de hombres por comuna

BDC_sexhom <- BCASEN1 %>%group_by(comuna)%>%summarise(hombre_porcentaje= length(which(sexo==1))
/(length(which(sexo==1))+
    length(which(sexo==2))))

BDC_sexmuj <- BCASEN1 %>%group_by(comuna)%>%summarise(mujer_porcentaje= length(which(sexo==2))
/(length(which(sexo==1))+
    length(which(sexo==2))))

# Merge sexos
BDC_sex <- merge(BDC_sexhom, BDC_sexmuj, by = "comuna")

#Comprobar
BDC_sex$total_sex <- BDC_sex$hombre_porcentaje + BDC_sex$mujer_porcentaje
any(BDC_sex$total_sex==!1)

#Sistema de salud
# Porcentaje de Fonasa A por comuna
BDC_sist_fonA <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaA_porcentaje= length(which(sistemasalud==1))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje de Fonasa B por comuna
BDC_sist_fonB <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaB_porcentaje= length(which(sistemasalud==2))           /(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje de Fonasa C por Comuna
BDC_sist_fonC <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaC_porcentaje= length(which(sistemasalud==3))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje de Fonasa D por comuna
BDC_sist_fonD <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaD_porcentaje= length(which(sistemasalud==4))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje de Fonasa No sabe grupo
BDC_sist_fonNS <- BCASEN1 %>%group_by(comuna)%>%summarise(fonasaNS_porcentaje= length(which(sistemasalud==5))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

#Merges FONASA
BDC_fonAyfonB <- merge(BDC_sist_fonA, BDC_sist_fonB, by = "comuna")
BDC_fonCyfonD <- merge(BDC_sist_fonC, BDC_sist_fonD, by = "comuna")
BDC_fonABCD <- merge(BDC_fonAyfonB, BDC_fonCyfonD, by = "comuna")
BDC_fon <- merge(BDC_fonABCD, BDC_sist_fonNS, by = "comuna")

# Porcentaje ffaa
BDC_sist_ffaa <- BCASEN1 %>%group_by(comuna)%>%summarise(ffaa_porcentaje= length(which(sistemasalud==6))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje Isapre
BDC_sist_isapre <- BCASEN1 %>%group_by(comuna)%>%summarise(isapre_porcentaje= length(which(sistemasalud==7))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje Ninguno (particular)
BDC_sist_ninguno_particular_porcentaje <- BCASEN1 %>%group_by(comuna)%>%summarise(ninguno_particular_porcentaje= length(which(sistemasalud==8))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje Otro sistema
BDC_sist_otro <- BCASEN1 %>%group_by(comuna)%>%summarise(otrosistema_porcentaje= length(which(sistemasalud==9))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

# Porcentaje No sabe
BDC_sist_NS <- BCASEN1 %>%group_by(comuna)%>%summarise(nosabegrupo_porcentaje= length(which(sistemasalud==99))
/(length(which(sistemasalud==1))+
   length(which(sistemasalud==2))+
    length(which(sistemasalud==3))+
     length(which(sistemasalud==4))+
      length(which(sistemasalud==5))+
       length(which(sistemasalud==6))+                                                                                         length(which(sistemasalud==7))+                                                                                         length(which(sistemasalud==8))+                                                                                          length(which(sistemasalud==9))+                                                                                          length(which(sistemasalud==99))))

#Merges sistemas no fonasa
BDC_ffaeisapre <- merge(BDC_sist_ffaa, BDC_sist_isapre, by = "comuna")
BDC_ningunoyotro <- merge(BDC_sist_ninguno_particular_porcentaje, BDC_sist_otro, by= "comuna")
BDC_1234 <- merge(BDC_ffaeisapre, BDC_ningunoyotro, by = "comuna")
BDC_sist_nofon <- merge(BDC_1234, BDC_sist_NS, by = "comuna")


#Merge sistemas salud
BDC_sistsalud <- merge(BDC_fon, BDC_sist_nofon)

# Comprobar
BDC_sistsalud$total_sistsalud <- BDC_sistsalud$fonasaA_porcentaje + BDC_sistsalud$fonasaB_porcentaje + BDC_sistsalud$fonasaC_porcentaje + BDC_sistsalud$fonasaD_porcentaje + BDC_sistsalud$fonasaNS_porcentaje + BDC_sistsalud$ffaa_porcentaje + BDC_sistsalud$isapre_porcentaje + BDC_sistsalud$ninguno_particular_porcentaje + BDC_sistsalud$otrosistema_porcentaje + BDC_sistsalud$nosabegrupo_porcentaje

any(BDC_sistsalud$total_sistsalud == ! 1)

#Nivel educacional 
#Porcentaje de sin educación formal por comuna 
BDC_educ_sin <- BCASEN1 %>%group_by(comuna)%>%summarise(sineducformal_porcentaje= 
length(which(educ==0))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))
                                                        
#Porcentaje de Basica incompleta por comuna 
BDC_educ_basic_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educbasicincomplete_porcentaje= 
length(which(educ==1))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Basica completa por comuna 
BDC_educ_basic_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educbasiccomplete_porcentaje= 
length(which(educ==2))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Media humanista incompleta por comuna
BDC_educ_hum_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educhumincomplete_porcentaje= 
length(which(educ==3))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Media técnica profesional incompleta por comuna
BDC_educ_tec_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(eductecincomplete_porcentaje= 
length(which(educ==4))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Media humanista completa por comnuna
BDC_educ_hum_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educhumcompleta_porcentaje= 
length(which(educ==5))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Media técnica profesional completa por comuna 
BDC_educ_tec_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educteccomplete_porcentaje= 
length(which(educ==6))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))



#Porcentaje de Técnico nivel Superior incompleta por comuna
BDC_educ_sup_tec_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsuptecincomplete_porcentaje= 
length(which(educ==7))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Técnico nivel Superior completo por comuna
BDC_educ_sup_tec_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsupteccomplete_porcentaje=
length(which(educ==8))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))


#Porcentaje de Profesional incompleto por comuna
BDC_educ_sup_prof_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsupprofincomplete_porcentaje= 
length(which(educ==9))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))


#Porcentaje de Postgrado incompleto por comuna 
BDC_educ_sup_post_incomplete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsuppostincomplete_porcentaje= 
length(which(educ==10))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Profesional completo por comuna
BDC_educ_sup_prof_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsupprofcomplete_porcentaje= 
length(which(educ==11))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Porcentaje de Postgrado completo por comuna
BDC_educ_sup_post_complete <- BCASEN1 %>%group_by(comuna)%>%summarise(educsuppostcomplete_porcentaje= 
length(which(educ==12))
/(length(which(educ==0))+
  length(which(educ==1))+
   length(which(educ==2))+
    length(which(educ==3))+
     length(which(educ==4))+
      length(which(educ==5))+
       length(which(educ==6))+
        length(which(educ==7))+
         length(which(educ==8))+
          length(which(educ==9))+
           length(which(educ==10))+
            length(which(educ==11))+
             length(which(educ==12))))

#Merge niveles educacionales según completo e incompleto por comuna 
BDC_educ_basiclevel <- merge(BDC_educ_basic_complete, BDC_educ_basic_incomplete, by = "comuna")
BDC_educ_sineduc_basiclevel <- merge(BDC_educ_sin, BDC_educ_basiclevel, by = "comuna")
BDC_educ_humlevel <- merge(BDC_educ_hum_complete, BDC_educ_hum_incomplete, by = "comuna")
BDC_educ_teclevel <- merge(BDC_educ_tec_complete, BDC_educ_tec_incomplete, by = "comuna")
BDC_educ_sup_proflevel <- merge(BDC_educ_sup_prof_complete, BDC_educ_sup_prof_incomplete, by = "comuna")
BDC_educ_sup_teclevel <- merge(BDC_educ_sup_tec_complete, BDC_educ_sup_tec_incomplete, by = "comuna")
BDC_educ_sup_postlevel <- merge(BDC_educ_sup_post_complete, BDC_educ_sup_post_incomplete, by = "comuna")

BDC_media <- merge(BDC_educ_humlevel, BDC_educ_teclevel, by = "comuna")
BDC_mediaybasica <- merge(BDC_educ_sineduc_basiclevel, BDC_media, by = "comuna")
BDC_superior <- merge(BDC_educ_sup_teclevel, BDC_educ_sup_proflevel, by = "comuna")
BDC_superiorypost <- merge(BDC_superior, BDC_educ_sup_postlevel, by = "comuna")
BDC_niveleducacional <- merge(BDC_mediaybasica, BDC_superiorypost, by = "comuna")

#comprobar
BDC_niveleducacional$total_niveleducacional <- 
BDC_niveleducacional$sineducformal_porcentaje + 
  BDC_niveleducacional$educbasiccomplete_porcentaje +
   BDC_niveleducacional$educbasicincomplete_porcentaje + 
    BDC_niveleducacional$educhumcompleta_porcentaje + 
     BDC_niveleducacional$educhumincomplete_porcentaje + 
      BDC_niveleducacional$educteccomplete_porcentaje + 
       BDC_niveleducacional$eductecincomplete_porcentaje + 
        BDC_niveleducacional$educsupteccomplete_porcentaje + 
         BDC_niveleducacional$educsuptecincomplete_porcentaje + 
          BDC_niveleducacional$educsupprofcomplete_porcentaje + 
           BDC_niveleducacional$educsupprofincomplete_porcentaje + 
            BDC_niveleducacional$educsuppostcomplete_porcentaje +
             BDC_niveleducacional$educsuppostincomplete_porcentaje


any(BDC_niveleducacional$total_niveleducacional == !1)

# Deciles por comuna
# Porcentaje decil 1 por comuna
BDC_decil1 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil1_porcentaje= length(which(decilautonomo==1))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 2 por comuna
BDC_decil2 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil2_porcentaje= length(which(decilautonomo==2))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 3 por comuna
BDC_decil3 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil3_porcentaje= length(which(decilautonomo==3))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 4 por comuna
BDC_decil4 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil4_porcentaje= length(which(decilautonomo==4))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 5 por comuna
BDC_decil5 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil5_porcentaje= length(which(decilautonomo==5))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 6 por comuna
BDC_decil6 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil6_porcentaje= length(which(decilautonomo==6))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 7 por comuna
BDC_decil7 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil7_porcentaje= length(which(decilautonomo==7))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 8 por comuna
BDC_decil8 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil8_porcentaje= length(which(decilautonomo==8))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 9 por comuna
BDC_decil9 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil9_porcentaje= length(which(decilautonomo==9))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))

# Porcentaje decil 10 por comuna
BDC_decil10 <- BCASEN1 %>%group_by(comuna)%>%summarise(decil10_porcentaje= length(which(decilautonomo==10))
/(length(which(decilautonomo==1))+
   length(which(decilautonomo==2))+
    length(which(decilautonomo==3))+
     length(which(decilautonomo==4))+
      length(which(decilautonomo==5))+
       length(which(decilautonomo==6))+                                                                                         length(which(decilautonomo==7))+                                                                                         length(which(decilautonomo==8))+                                                                                          length(which(decilautonomo==9))+                                                                                          length(which(decilautonomo==10))))
# Merges
BDC_d1yd2 <- merge(BDC_decil1, BDC_decil2, by = "comuna")
BDC_d3yd4 <- merge (BDC_decil3, BDC_decil4, by = "comuna")
BDC_d5yd6 <- merge(BDC_decil5, BDC_decil6, by = "comuna")
BDC_d7yd8 <- merge(BDC_decil7, BDC_decil8, by = "comuna")
BDC_d9yd10 <- merge(BDC_decil9, BDC_decil10, by = "comuna")
BDC_d1d2d3d4 <- merge(BDC_d1yd2, BDC_d3yd4, by = "comuna")
BDC_d5d6d7d8 <- merge(BDC_d5yd6, BDC_d7yd8, by = "comuna")
BDC_descs <- merge(BDC_d1d2d3d4, BDC_d5d6d7d8, by = "comuna")
BDC_deciles <- merge(BDC_descs, BDC_d9yd10, by = "comuna")

# Comprobar
BDC_deciles$total_deciles <- BDC_deciles$decil1_porcentaje + BDC_deciles$decil2_porcentaje + BDC_deciles$decil3_porcentaje + BDC_deciles$decil4_porcentaje + BDC_deciles$decil5_porcentaje + BDC_deciles$decil6_porcentaje + BDC_deciles$decil7_porcentaje + BDC_deciles$decil8_porcentaje + BDC_deciles$decil9_porcentaje + BDC_deciles$decil10_porcentaje

any (BDC_deciles$total_deciles == !1)

#Metros cuadrados de vivienda por comuna 
#Porcenate menos de 30 m2 por comuna
BDC_m2_30 <- BCASEN1 %>%group_by(comuna)%>%summarise(tamano_vivienda_30m_porcentaje= 
length(which(tamano_vivienda==1))
/(length(which(tamano_vivienda==1))+
   length(which(tamano_vivienda==2))+
    length(which(tamano_vivienda==3))+
     length(which(tamano_vivienda==4))+
      length(which(tamano_vivienda==5))+
       length(which(tamano_vivienda==6))))
          

#Porcentaje de 30 a 40 m2 por comuna
BDC_m2_30a40 <- BCASEN1 %>%group_by(comuna)%>%summarise(tamano_vivienda_30a40m_porcentaje= 
length(which(tamano_vivienda==2))
/(length(which(tamano_vivienda==1))+
   length(which(tamano_vivienda==2))+
    length(which(tamano_vivienda==3))+
     length(which(tamano_vivienda==4))+
      length(which(tamano_vivienda==5))+
       length(which(tamano_vivienda==6))))
          


#Porcentaje de 41 a 60 m2 por comuna
BDC_m2_41a60 <- BCASEN1 %>%group_by(comuna)%>%summarise(tamano_vivienda_41a60m_porcentaje= 
length(which(tamano_vivienda==3))
/(length(which(tamano_vivienda==1))+
   length(which(tamano_vivienda==2))+
    length(which(tamano_vivienda==3))+
     length(which(tamano_vivienda==4))+
      length(which(tamano_vivienda==5))+
       length(which(tamano_vivienda==6))))
          

#Porcentaje de  61 a 100 m2 por comuna
BDC_m2_61a100 <- BCASEN1 %>%group_by(comuna)%>%summarise(tamano_vivienda_61a100m_porcentaje= 
length(which(tamano_vivienda==4))
/(length(which(tamano_vivienda==1))+
   length(which(tamano_vivienda==2))+
    length(which(tamano_vivienda==3))+
     length(which(tamano_vivienda==4))+
      length(which(tamano_vivienda==5))+
       length(which(tamano_vivienda==6))))
          


#Porcentaje de 101 a 150 m2 por comuna
BDC_m2_101a150 <- BCASEN1 %>%group_by(comuna)%>%summarise(tamano_vivienda_101a150m_porcentaje= 
length(which(tamano_vivienda==5))
/(length(which(tamano_vivienda==1))+
   length(which(tamano_vivienda==2))+
    length(which(tamano_vivienda==3))+
     length(which(tamano_vivienda==4))+
      length(which(tamano_vivienda==5))+
       length(which(tamano_vivienda==6))))
          

#Porcentaje de más de 150 m2 por comuna
BDC_m2_150ymas <- BCASEN1 %>%group_by(comuna)%>%summarise(tamano_vivienda_150ymasm_porcentaje= 
length(which(tamano_vivienda==6))
/(length(which(tamano_vivienda==1))+
   length(which(tamano_vivienda==2))+
    length(which(tamano_vivienda==3))+
     length(which(tamano_vivienda==4))+
      length(which(tamano_vivienda==5))+
       length(which(tamano_vivienda==6))))
        

#Merge variables 
BDC_tamano_vivienda_pequena <- merge(BDC_m2_30, BDC_m2_30a40, by = "comuna")
BDC_tamano_vivienda_mediana <- merge(BDC_m2_41a60, BDC_m2_61a100, by = "comuna")
BDC_tamano_vivienda_grande <- merge(BDC_m2_101a150, BDC_m2_150ymas, by = "comuna")

BDC_tamano_vivienda <- merge(BDC_tamano_vivienda_pequena, BDC_tamano_vivienda_mediana, by = "comuna")
BDC_tamano_vivienda <- merge(BDC_tamano_vivienda, BDC_tamano_vivienda_grande, by = "comuna")

#Comprobar 
BDC_tamano_vivienda$total_tamano_vivienda <- BDC_tamano_vivienda$tamano_vivienda_30m_porcentaje + BDC_tamano_vivienda$tamano_vivienda_30a40m_porcentaje + BDC_tamano_vivienda$tamano_vivienda_41a60m_porcentaje + BDC_tamano_vivienda$tamano_vivienda_61a100m_porcentaje + BDC_tamano_vivienda$tamano_vivienda_101a150m_porcentaje + BDC_tamano_vivienda$tamano_vivienda_150ymasm_porcentaje

any(any (BDC_tamano_vivienda$total_tamano_vivienda == !1))


#Merge de variables categoricas
BDC_sexysistsalud <- merge(BDC_sex, BDC_sistsalud, by = "comuna")
BDC_saludydeciles <- merge(BDC_sexysistsalud, BDC_deciles, by = "comuna")
BDC_cat <- merge(BDC_niveleducacional, BDC_saludydeciles, by = "comuna")
BDC_cat <- merge(BDC_cat, BDC_tamano_vivienda, by = "comuna")
```

Una vez agrupadas las nuevas variables en aquellas numericas y categoricas, procedemos a unirlas en una sola base
```{r}
BDC <- merge(BDC_num, BDC_cat, by = "comuna")
```

```{r}
# Analizar que tipo de variables son las de la base
num.names = BDC %>% select_if(is.numeric) %>% colnames()
cat.names = BDC %>% select_if(is.character) %>% colnames()
fac.names = BDC %>% select_if(is.factor) %>% colnames()
lab.names = BDC %>% select_if(is.labelled) %>% colnames()
print(num.names)
print(cat.names)
print(fac.names)
print(lab.names)
```

```{r}
# Cambiar variables "labelled"

BDC[,lab.names] = data.frame(apply(BDC[lab.names], 2, as.numeric))
str(BDC[,lab.names])
```

Hemos completado el tratamiento de la CASEN 2017. Ahora queda unirla a la base de datos de infectados con COVID 19
```{r}
#Unir bases
class(BDC)
class(BCV19c)
BDCV19 <- merge(BCV19c, BDC, by = "comuna")
```

```{r}
# Etiquetas

BDCV19$comuna  <- set_label(x = BDCV19$comuna, label = "Codigos de comuna")
BDCV19$nombre_region <- set_label(x = BDCV19$nombre_region, label = "Nombre de region")
BDCV19$region  <- set_label(x = BDCV19$region, label = "Codigos de region")
BDCV19$nombre_comuna  <- set_label(x = BDCV19$nombre_comuna, label = "Nombre de comuna")
BDCV19$poblacion  <- set_label(x = BDCV19$poblacion, label = "Poblacion de la comuna")
BDCV19$casos_confirmados  <- set_label(x = BDCV19$casos_confirmados, label = "Cantidad casos confirmados en la comuna")


BDCV19$ingreso_media <- set_label(x = BDCV19$ingreso_media, label = "Media de ingresos por comuna")
BDCV19$ingreso_mediana <- set_label(x = BDCV19$ingreso_mediana, label = "Mediana de ingresos por comuna")
BDCV19$ingreso_desviacionestandar <- set_label(x = BDCV19$ingreso_desviacionestandar, label = "Desviacion estandar de ingresos por comuna")


BDCV19$ingresohogar_media<- set_label(x = BDCV19$ingresohogar_media, label = "Media de ingresos por hogar por comuna")
BDCV19$ingresohogar_mediana<- set_label(x = BDCV19$ingresohogar_mediana, label = "Mediana de ingresos por hogar por comuna")
BDCV19$ingresohogar_desviacionestandar<- set_label(x = BDCV19$ingresohogar_desviacionestandar, label = "Desviacion estandar de ingresos por hogar por comuna")


BDCV19$edad_media<- set_label(x = BDCV19$edad_media, label = "Media de edad por comuna")
BDCV19$edad_mediana<- set_label(x = BDCV19$edad_mediana, label = "Mediana de edad por comuna")
BDCV19$edad_desviacionestandar<- set_label(x = BDCV19$edad_desviacionestandar, label = "Desviacion estandar de edad por comuna")


BDCV19$anosescolaridad_media<- set_label(x = BDCV19$anosescolaridad_media, label = "Media de años de escolaridad por comuna")
BDCV19$anosescolaridad_mediana<- set_label(x = BDCV19$anosescolaridad_mediana, label = "Mediana de años de escolaridad por comuna")
BDCV19$anosescolaridad_desviacionestandar<- set_label(x = BDCV19$anosescolaridad_desviacionestandar, label = "Desviacion estandar de años de escolaridad por comuna")


BDCV19$pobreza_media<- set_label(x = BDCV19$pobreza_media, label = "Media de pobreza por comuna")
BDCV19$pobreza_mediana<- set_label(x = BDCV19$pobreza_mediana, label = "Mediana de pobreza por comuna")
BDCV19$pobreza_desviacionestandar<- set_label(x = BDCV19$pobreza_desviacionestandar, label = "Desviacion estandar de pobreza por comuna")


BDCV19$hacinamiento_hogar_media<- set_label(x = BDCV19$hacinamiento_hogar_media, label = "Media de hacinamiento por comuna")
BDCV19$hacinamiento_hogar_mediana<- set_label(x = BDCV19$hacinamiento_hogar_mediana, label = "Mediana de hacinamiento por comuna")
BDCV19$hacinamiento_hogar_desviacionestandar<- set_label(x = BDCV19$hacinamiento_hogar_desviacionestandar, label = "Desviacion estandar de hacinamiento por comuna")


BDCV19$total_personas_hogar_media<- set_label(x = BDCV19$total_personas_hogar_media, label = "Media del total de personas por hogar por comuna")
BDCV19$total_personas_hogar_mediana<- set_label(x = BDCV19$total_personas_hogar_mediana, label = "Mediana del total de personas por hogar por comuna")
BDCV19$total_personas_hogar_desviacionestandar<- set_label(x = BDCV19$total_personas_hogar_desviacionestandar, label = "Desviacion estandar del total de personas por hogar por comuna")


BDCV19$deficit_prevs_hogar_media<- set_label(x = BDCV19$deficit_prevs_hogar_media, label = "Media del deficit de adscripcion al sistema de salud por comuna")
BDCV19$deficit_prevs_hogar_mediana<- set_label(x = BDCV19$deficit_prevs_hogar_mediana, label = "Mediana del deficit de adscripcion al sistema de salud por comuna")
BDCV19$deficit_prevs_hogar_desviacionestandar<- set_label(x = BDCV19$deficit_prevs_hogar_desviacionestandar, label = "Desviacion estandar del deficit de adscripcion al sistema de salud por comuna")


BDCV19$deficit_servbas_hogar_media<- set_label(x = BDCV19$deficit_servbas_hogar_media, label = "Media del deficit de servicios basicos por comuna")
BDCV19$deficit_servbas_hogar_mediana<- set_label(x = BDCV19$deficit_servbas_hogar_mediana, label = "Mediana del deficit de servicios basicos por comuna")
BDCV19$deficit_servbas_hogar_desviacionestandar<- set_label(x = BDCV19$deficit_servbas_hogar_desviacionestandar, label = "Media del deficit de servicios basicos por comuna")


BDCV19$sineducformal_porcentaje<- set_label(x = BDCV19$sineducformal_porcentaje, label = "Porcentaje de sin educacion formal por comuna")
BDCV19$educbasiccomplete_porcentaje<- set_label(x = BDCV19$educbasiccomplete_porcentaje, label = "Porcentaje de educacion basica completa por comuna")
BDCV19$educbasicincomplete_porcentaje<- set_label(x = BDCV19$educbasicincomplete_porcentaje, label = "Porcentaje de educacion basica incompleta por comuna")
BDCV19$educhumcompleta_porcentaje<- set_label(x = BDCV19$educhumcompleta_porcentaje, label = "Porcentaje de educacion humanista completa por comuna")
BDCV19$educhumincomplete_porcentaje<- set_label(x = BDCV19$educhumincomplete_porcentaje, label = "Porcentaje de educacion humanista incompleta por comuna")
BDCV19$educteccomplete_porcentaje<- set_label(x = BDCV19$educteccomplete_porcentaje, label = "Porcentaje de educacion tecnica completa por comuna")
BDCV19$eductecincomplete_porcentaje<- set_label(x = BDCV19$eductecincomplete_porcentaje, label = "Porcentaje de educacion tecnica incompleta por comuna")
BDCV19$educsupteccomplete_porcentaje<- set_label(x = BDCV19$educsupteccomplete_porcentaje, label = "Porcentaje de educacion superior tecnica completa por comuna")
BDCV19$educsuptecincomplete_porcentaje<- set_label(x = BDCV19$educsuptecincomplete_porcentaje, label = "Porcentaje de educacion superior tecnica incompleta por comuna")
BDCV19$educsupprofcomplete_porcentaje<- set_label(x = BDCV19$educsupprofcomplete_porcentaje, label = "Porcentaje de educacion superior profesional completa por comuna")
BDCV19$educsupprofincomplete_porcentaje<- set_label(x = BDCV19$educsupprofincomplete_porcentaje, label = "Porcentaje de educacion superior profesional incompleta por comuna")
BDCV19$educsuppostcomplete_porcentaje<- set_label(x = BDCV19$educsuppostcomplete_porcentaje, label = "Porcentaje de educacion superior de postgrado completa por comuna")
BDCV19$educsuppostincomplete_porcentaje<- set_label(x = BDCV19$educsuppostincomplete_porcentaje, label = "Porcentaje de educacion superior de postgrado incompleta por comuna")
BDCV19$total_niveleducacional<- set_label(x = BDCV19$total_niveleducacional, label = "Suma de todos los porcentajes de las filas para el nivel educacional")

BDCV19$hombre_porcentaje<- set_label(x = BDCV19$hombre_porcentaje, label = "Porcentaje de hombres por comuna")
BDCV19$mujer_porcentaje<- set_label(x = BDCV19$mujer_porcentaje, label = "Porcentaje de mujeres por comuna")
BDCV19$total_sex<- set_label(x = BDCV19$total_sex, label = "Suma de todos los porcentajes de las filas para el sexo")


BDCV19$fonasaA_porcentaje<- set_label(x = BDCV19$fonasaA_porcentaje, label = "Porcentaje de adscripcion a sistema de salud fonasa A por comuna")
BDCV19$fonasaB_porcentaje<- set_label(x = BDCV19$fonasaB_porcentaje, label = "Porcentaje de adscripcion a sistema de salud fonasa B por comuna")
BDCV19$fonasaC_porcentaje<- set_label(x = BDCV19$fonasaC_porcentaje, label = "Porcentaje de adscripcion a sistema de salud fonasa C por comuna")
BDCV19$fonasaD_porcentaje<- set_label(x = BDCV19$fonasaD_porcentaje, label = "Porcentaje de adscripcion a sistema de salud fonasa D por comuna")
BDCV19$fonasaNS_porcentaje<- set_label(x = BDCV19$fonasaNS_porcentaje, label = "Porcentaje de gente que no conoce a que grupo de fonasa pertenece por comuna")
BDCV19$ffaa_porcentaje<- set_label(x = BDCV19$ffaa_porcentaje, label = "Porcentaje de adscripcion a sistema de salud de fuerzas armadas por comuna")
BDCV19$isapre_porcentaje<- set_label(x = BDCV19$isapre_porcentaje, label = "Porcentaje de adscripcion a sistema de salud isapre por comuna")
BDCV19$ninguno_particular_porcentaje<- set_label(x = BDCV19$ninguno_particular_porcentaje, label = "Porcentaje sin previsión sistema salud (particulares) a nivel comunal")
BDCV19$otrosistema_porcentaje<- set_label(x = BDCV19$otrosistema_porcentaje, label = "Porcentaje de adscripción a otro sistema salud a nivel comunal")
BDCV19$nosabegrupo_porcentaje<- set_label(x = BDCV19$nosabegrupo_porcentaje, label = "Porcentaje que no conoce su previsión de salud a nivel comunal")
BDCV19$total_sistsalud<- set_label(x = BDCV19$total_sistsalud, label = "Suma de todos los porcentajes de las filas para el sistema de salud")

BDCV19$decil1_porcentaje<- set_label(x = BDCV19$decil1_porcentaje, label = "Porcentaje de personas correspondientes al decil 1 por comuna")
BDCV19$decil2_porcentaje<- set_label(x = BDCV19$decil2_porcentaje, label = "Porcentaje de personas correspondientes al decil 2 por comuna")
BDCV19$decil3_porcentaje<- set_label(x = BDCV19$decil3_porcentaje, label = "Porcentaje de personas correspondientes al decil 3 por comuna")
BDCV19$decil4_porcentaje<- set_label(x = BDCV19$decil4_porcentaje, label = "Porcentaje de personas correspondientes al decil 4 por comuna")
BDCV19$decil5_porcentaje<- set_label(x = BDCV19$decil5_porcentaje, label = "Porcentaje de personas correspondientes al decil 5 por comuna")
BDCV19$decil6_porcentaje<- set_label(x = BDCV19$decil6_porcentaje, label = "Porcentaje de personas correspondientes al decil 6 por comuna")
BDCV19$decil7_porcentaje<- set_label(x = BDCV19$decil7_porcentaje, label = "Porcentaje de personas correspondientes al decil 7 por comuna")
BDCV19$decil8_porcentaje<- set_label(x = BDCV19$decil8_porcentaje, label = "Porcentaje de personas correspondientes al decil 8 por comuna")
BDCV19$decil9_porcentaje<- set_label(x = BDCV19$decil9_porcentaje, label = "Porcentaje de personas correspondientes al decil 9 por comuna")
BDCV19$decil10_porcentaje<- set_label(x = BDCV19$decil10_porcentaje, label = "Porcentaje de personas correspondientes al decil 10 por comuna")
BDCV19$total_deciles<- set_label(x = BDCV19$total_deciles, label = "Suma de todos los porcentajes de las filas para los deciles")


BDCV19$tamano_vivienda_30m_porcentaje<- set_label(x = BDCV19$tamano_vivienda_30m_porcentaje, label = "Porcentaje de personas que habitan una vivienda menor a 30m por comuna ")
BDCV19$tamano_vivienda_30a40m_porcentaje<- set_label(x = BDCV19$tamano_vivienda_30a40m_porcentaje, label = "Porcentaje de personas que habitan una vivienda entre 30m y 40m por comuna ")
BDCV19$tamano_vivienda_41a60m_porcentaje<- set_label(x = BDCV19$tamano_vivienda_41a60m_porcentaje, label = "Porcentaje de personas que habitan una vivienda entre 41m y 60m por comuna ")
BDCV19$tamano_vivienda_61a100m_porcentaje<- set_label(x = BDCV19$tamano_vivienda_61a100m_porcentaje, label = "Porcentaje de personas que habitan una vivienda entre 61m y 100m por comuna")
BDCV19$tamano_vivienda_101a150m_porcentaje<- set_label(x = BDCV19$tamano_vivienda_101a150m_porcentaje, label = "Porcentaje de personas que habitan una vivienda entre 101m y 150m por comuna")
BDCV19$tamano_vivienda_150ymasm_porcentaje<- set_label(x = BDCV19$tamano_vivienda_150ymasm_porcentaje, label = "Porcentaje de personas que habitan una vivienda de más de 150m por comuna")
BDCV19$total_tamano_vivienda<- set_label(x = BDCV19$total_tamano_vivienda, label = "Suma de todos los porcentajes de las filas para el tamaño de vivienda")





```


Una vez realizado esto, podemos guardar la base en el formato que queramos, en este caso será .xlsx
```{r}
write.xlsx(BDCV19, "CASEN-COVID19.xlsx")
```

```{r}
save(BDCV19,file = "CASEN-COVID19.RData")
```




